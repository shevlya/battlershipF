<div class="game-container">
  <div class="game-header">
    <div class="game-id">Игра с компьютером #{{ gameId }}</div>
    <button class="btn back-btn" (click)="router.navigate(['/'])">Вернуться в меню</button>
  </div>

  <div *ngIf="loading" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div>Загрузка игры...</div>
  </div>

  <div *ngIf="error" class="error-message">
    {{ error }}
    <button class="btn retry-btn" (click)="loadGameState()">Попробовать снова</button>
  </div>

  <div class="fields-container">
    <!-- Ваше поле - отображает ВАШИ корабли и ВЫСТРЕЛЫ КОМПЬЮТЕРА по вам -->
    <div class="field-section">
      <h3>Ваше поле</h3>
      <div class="ships-count">Корабли: {{ myShipsCount }}/10</div>
      <div class="battlefield">
        <div class="coordinates-row">
          <div class="corner"></div>
          <div *ngFor="let col of columns" class="coordinate">{{ col }}</div>
        </div>
        <div *ngFor="let row of rows; let i = index" class="battlefield-row">
          <div class="coordinate">{{ row }}</div>
          <div
            *ngFor="let col of columns; let j = index"
            class="cell"
            [class.ship]="myField[i][j] === 'S' && myHits[i][j] !== 'H'"
            [class.hit]="myHits[i][j] === 'H'"
            [class.miss]="myHits[i][j] === 'M'"
            [class.sunk]="isShipSunk(i, j, true)">

            @if (myHits[i][j] === 'H') {
              <span class="hit-mark">✕</span>
            }
            @if (myHits[i][j] === 'M') {
              <span class="miss-mark">•</span>
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Поле компьютера - отображает ТОЛЬКО ВАШИ выстрелы по компьютеру -->
    <div class="field-section">
      <h3>Поле компьютера</h3>
      <div class="ships-count">Корабли: {{ opponentShipsCount }}/10</div>
      <div class="battlefield">
        <div class="coordinates-row">
          <div class="corner"></div>
          <div *ngFor="let col of columns" class="coordinate">{{ col }}</div>
        </div>
        <div *ngFor="let row of rows; let i = index" class="battlefield-row">
          <div class="coordinate">{{ row }}</div>
          <div
            *ngFor="let col of columns; let j = index"
            class="cell"
            [class.hit]="opponentField[i][j] === 'H'"
            [class.miss]="opponentField[i][j] === 'M'"
            [class.sunk]="isShipSunk(i, j, false)"
            [class.selectable]="isYourTurn && opponentField[i][j] === ' ' && !gameState.gameOver"
            (click)="onOpponentCellClick(i, j)">

            @if (opponentField[i][j] === 'H') {
              <span class="hit-mark">✕</span>
            }
            @if (opponentField[i][j] === 'M') {
              <span class="miss-mark">•</span>
            }
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="game-controls">
    <div class="controls-left">
      <div class="shots-info">
        <div class="shot-stat">
          <span class="label">Ваши выстрелы:</span>
          <span class="value">{{ myShotsCount }}</span>
        </div>
        <div class="shot-stat">
          <span class="label">Попадания:</span>
          <span class="value hits">{{ myHitsCount }}</span>
        </div>
      </div>
    </div>

    <div class="controls-center">
      <div class="turn-status" [class.your-turn]="isYourTurn" [class.computer-turn]="!isYourTurn">
        <span *ngIf="gameState.gameOver">
          {{ gameState.winner === 'HUMAN' ? 'Вы победили!' : 'Компьютер победил!' }}
        </span>
        <span *ngIf="!gameState.gameOver">
          {{ isYourTurn ? 'Ваш ход' : 'Ход компьютера...' }}
        </span>
      </div>
    </div>

    <div class="controls-right">
      <div class="action-buttons">
        <button class="btn coral" (click)="surrender()" [disabled]="gameState.gameOver || loading">
          Сдаться
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Попап для сдачи -->
@if (showSurrenderPopup) {
  <div class="popup-overlay" (click)="cancelSurrender()">
    <div class="popup-content" (click)="$event.stopPropagation()">
      <div class="popup-header">
        <h3>Вы уверены, что хотите сдаться?</h3>
        <button class="popup-close" (click)="cancelSurrender()">&times;</button>
      </div>
      <div class="popup-body">
        <p class="warning-text">После нажатия кнопки "Сдаться", действие нельзя будет отменить!</p>
        <div class="surrender-actions">
          <button class="btn coral" (click)="confirmSurrender()" [disabled]="loading">
            {{ loading ? 'Обработка...' : 'Сдаться' }}
          </button>
          <button class="btn" (click)="cancelSurrender()" [disabled]="loading">Отмена</button>
        </div>
      </div>
    </div>
  </div>
}

<!-- Попап окончания игры -->
@if (showGameOverPopup) {
  <div class="popup-overlay">
    <div class="popup-content">
      <div class="popup-header">
        <h3>Игра завершена</h3>
      </div>
      <div class="popup-body">
        <p class="result-message">{{ gameOverMessage }}</p>
        <div class="game-over-actions">
          <button class="btn primary" (click)="router.navigate(['/game/new-computer'])">
            Новая игра
          </button>
          <button class="btn" (click)="router.navigate(['/'])">
            В меню
          </button>
        </div>
      </div>
    </div>
  </div>
}
