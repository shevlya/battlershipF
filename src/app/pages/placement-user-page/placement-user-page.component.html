<div class="placement-container">
  <h2>Ваше игровое поле</h2>
  
  <div class="main-content">
    <div class="game-board-section">
      <div class="game-board" 
           (dragover)="onDragOver($event)" 
           (drop)="onDrop($event)"
           (dragleave)="onDragLeave($event)">
        <div class="board-header">
          <div class="empty-cell"></div>
          @for (col of columns; track col) {
            <div class="column-header">{{col}}</div>
          }
        </div>
        
        @for (row of rows; track row) {
          <div class="board-row">
            <div class="row-header">{{row}}</div>
            @for (col of columns; track col) {
              <div 
                class="cell" 
                [attr.data-row]="row"
                [attr.data-col]="col"
                [class.has-ship]="hasShip(row, col)"
                [class.valid-drop]="isValidDropZone(row, col)"
                [class.invalid-drop]="isInvalidDropZone(row, col)">
              </div>
            }
          </div>
        }
      </div>
      
      <div class="action-buttons">
        <button class="btn" 
                (click)="openSavePopup()" 
                [disabled]="!hasAtLeastOneShip()">
          Сохранить расстановку
        </button>
        <button class="btn" (click)="generateRandom()">Сгенерировать случайно</button>
        <button class="btn" (click)="openLoadPopup()">Загрузить расстановку</button>
        <button class="btn coral" 
                (click)="requestClearBoard()" 
                [disabled]="!hasAtLeastOneShip()">
          Очистить поле
        </button>
        <button class="btn primary" 
                (click)="startGame()" 
                [disabled]="!isAllShipsPlaced()">
          Начать игру
        </button>
      </div>
    </div>
    
    <div class="sidebar">
      <div class="ships-panel">
        <h3>Корабли для расстановки:</h3>
        <div class="orientation-info">
          <span class="orientation-label">Ориентация:</span>
          <span class="orientation-value">{{isHorizontal ? 'Горизонтальная' : 'Вертикальная'}}</span>
          <span class="orientation-hint">(двойной клик по кораблю для смены)</span>
        </div>
        <div class="ships-list">
          <div class="ship-row">
            <!-- Линкор (4 клетки) -->
            @if (getRemainingShipsCount('battleship') > 0) {
              <div class="ship draggable" 
                   [class.vertical]="!isHorizontal"
                   data-size="4" 
                   data-type="battleship" 
                   draggable="true" 
                   (dragstart)="onDragStart($event)"
                   (dblclick)="toggleOrientation()">
                @for (i of [1,2,3,4]; track $index) {
                  <div class="ship-cell"></div>
                }
              </div>
            }
            
            <!-- Первый крейсер (3 клетки) -->
            @if (getRemainingShipsCount('cruiser') > 0) {
              <div class="ship draggable" 
                   [class.vertical]="!isHorizontal"
                   data-size="3" 
                   data-type="cruiser" 
                   draggable="true" 
                   (dragstart)="onDragStart($event)"
                   (dblclick)="toggleOrientation()">
                @for (i of [1,2,3]; track $index) {
                  <div class="ship-cell"></div>
                }
              </div>
            }
          </div>
          
          <div class="ship-row">
            <!-- Второй крейсер (3 клетки) -->
            @if (getRemainingShipsCount('cruiser') > 1) {
              <div class="ship draggable" 
                   [class.vertical]="!isHorizontal"
                   data-size="3" 
                   data-type="cruiser" 
                   draggable="true" 
                   (dragstart)="onDragStart($event)"
                   (dblclick)="toggleOrientation()">
                @for (i of [1,2,3]; track $index) {
                  <div class="ship-cell"></div>
                }
              </div>
            }
            
            <!-- Первый эсминец (2 клетки) -->
            @if (getRemainingShipsCount('destroyer') > 0) {
              <div class="ship draggable" 
                   [class.vertical]="!isHorizontal"
                   data-size="2" 
                   data-type="destroyer" 
                   draggable="true" 
                   (dragstart)="onDragStart($event)"
                   (dblclick)="toggleOrientation()">
                @for (i of [1,2]; track $index) {
                  <div class="ship-cell"></div>
                }
              </div>
            }
          </div>
          
          <div class="ship-row">
            <!-- Второй эсминец (2 клетки) -->
            @if (getRemainingShipsCount('destroyer') > 1) {
              <div class="ship draggable" 
                   [class.vertical]="!isHorizontal"
                   data-size="2" 
                   data-type="destroyer" 
                   draggable="true" 
                   (dragstart)="onDragStart($event)"
                   (dblclick)="toggleOrientation()">
                @for (i of [1,2]; track $index) {
                  <div class="ship-cell"></div>
                }
              </div>
            }
            
            <!-- Третий эсминец (2 клетки) -->
            @if (getRemainingShipsCount('destroyer') > 2) {
              <div class="ship draggable" 
                   [class.vertical]="!isHorizontal"
                   data-size="2" 
                   data-type="destroyer" 
                   draggable="true" 
                   (dragstart)="onDragStart($event)"
                   (dblclick)="toggleOrientation()">
                @for (i of [1,2]; track $index) {
                  <div class="ship-cell"></div>
                }
              </div>
            }
          </div>
          
          <div class="ship-row">
            <!-- Первый катер (1 клетка) -->
            @if (getRemainingShipsCount('boat') > 0) {
              <div class="ship draggable" 
                   data-size="1" 
                   data-type="boat" 
                   draggable="true" 
                   (dragstart)="onDragStart($event)"
                   (dblclick)="toggleOrientation()">
                <div class="ship-cell"></div>
              </div>
            }
            
            <!-- Второй катер (1 клетка) -->
            @if (getRemainingShipsCount('boat') > 1) {
              <div class="ship draggable" 
                   data-size="1" 
                   data-type="boat" 
                   draggable="true" 
                   (dragstart)="onDragStart($event)"
                   (dblclick)="toggleOrientation()">
                <div class="ship-cell"></div>
              </div>
            }
          </div>
          
          <div class="ship-row">
            <!-- Третий катер (1 клетка) -->
            @if (getRemainingShipsCount('boat') > 2) {
              <div class="ship draggable" 
                   data-size="1" 
                   data-type="boat" 
                   draggable="true" 
                   (dragstart)="onDragStart($event)"
                   (dblclick)="toggleOrientation()">
                <div class="ship-cell"></div>
              </div>
            }
            
            <!-- Четвертый катер (1 клетка) -->
            @if (getRemainingShipsCount('boat') > 3) {
              <div class="ship draggable" 
                   data-size="1" 
                   data-type="boat" 
                   draggable="true" 
                   (dragstart)="onDragStart($event)"
                   (dblclick)="toggleOrientation()">
                <div class="ship-cell"></div>
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Попап для подтверждения очистки поля -->
@if (showClearConfirmation) {
  <div class="popup-overlay" (click)="cancelClear()">
    <div class="popup-content" (click)="$event.stopPropagation()">
      <div class="popup-header">
        <h3>Вы уверены, что хотите очистить поле?</h3>
        <button class="popup-close" (click)="cancelClear()">&times;</button>
      </div>
      
      <div class="popup-body">
        <p>Все расставленные корабли будут удалены.</p>
        <div class="clear-actions">
          <button class="btn coral" (click)="confirmClear()">Очистить поле</button>
          <button class="btn" (click)="cancelClear()">Отмена</button>
        </div>
      </div>
    </div>
  </div>
}

<!-- Попап для сохранения расстановки -->
@if (showSavePopup) {
  <div class="popup-overlay" (click)="closeSavePopup()">
    <div class="popup-content" (click)="$event.stopPropagation()">
      <div class="popup-header">
        <h3>Сохранить расстановку</h3>
        <button class="popup-close" (click)="closeSavePopup()">&times;</button>
      </div>
      
      <div class="popup-body">
        <div class="save-form">
          <label for="placementName">Название расстановки:</label>
          <input type="text" 
                 id="placementName" 
                 [(ngModel)]="newPlacementName" 
                 placeholder="Введите название"
                 class="save-input"
                 (keyup.enter)="savePlacement()">
          <div class="save-actions">
            <button class="btn primary" (click)="savePlacement()">Сохранить</button>
            <button class="btn" (click)="closeSavePopup()">Отмена</button>
          </div>
        </div>
      </div>
    </div>
  </div>
}

<!-- Попап для загрузки расстановок -->
@if (showLoadPopup) {
  <div class="popup-overlay" (click)="closeLoadPopup()">
    <div class="popup-content" (click)="$event.stopPropagation()">
      <div class="popup-header">
        <h3>Загрузить расстановку</h3>
        <button class="popup-close" (click)="closeLoadPopup()">&times;</button>
      </div>
      
      <div class="popup-body">
        <div class="strategies-section">
          <h4>Базовые стратегии</h4>
          <div class="strategy-options">
            <button class="strategy-btn" (click)="loadStrategy('coastal')">
              <span class="strategy-name">Береговая стратегия</span>
              <span class="strategy-desc">Корабли размещаются преимущественно у границ поля</span>
            </button>
            
            <button class="strategy-btn" (click)="loadStrategy('diagonal')">
              <span class="strategy-name">Диагональная стратегия</span>
              <span class="strategy-desc">Корабли размещаются по диагоналям поля</span>
            </button>
            
            <button class="strategy-btn" (click)="loadStrategy('halfField')">
              <span class="strategy-name">Полупольная стратегия</span>
              <span class="strategy-desc">Корабли концентрируются в одной половине поля</span>
            </button>

            <button class="strategy-btn" (click)="loadStrategy('spread')">
              <span class="strategy-name">Стратегия разброса</span>
              <span class="strategy-desc">Хаотичное размещение без очевидных закономерностей</span>
            </button>
          </div>
        </div>
        
        <div class="user-placements-section">
          <h4>Мои расстановки</h4>
          @if (userPlacements.length > 0) {
            <div class="user-placements-list">
              @for (placement of userPlacements; track placement.id) {
                <div class="placement-item">
                  <span class="placement-name">{{ placement.name }}</span>
                  <span class="placement-date">{{ placement.date | date:'dd.MM.yyyy' }}</span>
                  <button class="placement-load-btn" (click)="loadUserPlacement(placement)">
                    Загрузить
                  </button>
                </div>
              }
            </div>
          } @else {
            <div class="no-placements">
              <p>У вас пока нет сохраненных расстановок</p>
            </div>
          }
        </div>
      </div>
    </div>
  </div>
}