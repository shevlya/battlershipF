import { Injectable } from '@angular/core';
import { HttpInterceptor, HttpRequest, HttpHandler, HttpEvent, HttpErrorResponse } from '@angular/common/http';
import { Observable, throwError } from 'rxjs';
import { AuthService } from '../services/auth.service';
import { tap, catchError } from 'rxjs/operators';

/**
 * HTTP Interceptor –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
 * 
 * –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
 * - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ JWT —Ç–æ–∫–µ–Ω–∞ –∫ –∑–∞—â–∏—â–µ–Ω–Ω—ã–º –∑–∞–ø—Ä–æ—Å–∞–º
 * - –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—É–±–ª–∏—á–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –∏–∑ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
 * - –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤
 * - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (401 Unauthorized)
 * - –û—Ç–ª–∞–¥–∫–∞ –ø—Ä–æ–±–ª–µ–º —Å —Ç–æ–∫–µ–Ω–∞–º–∏ –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
 * 
 * @injectable
 * 
 * –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã:
 * - –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –í–°–ï –∏—Å—Ö–æ–¥—è—â–∏–µ HTTP –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
 * - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ (–ø—É–±–ª–∏—á–Ω—ã–π/–∑–∞—â–∏—â–µ–Ω–Ω—ã–π)
 * - –î–æ–±–∞–≤–ª—è–µ—Ç Bearer —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∏ Authorization
 * - –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
 */
@Injectable()
export class AuthInterceptor implements HttpInterceptor {

  constructor(private authService: AuthService) {}

  /**
   * –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
   * 
   * –ü—Ä–æ—Ü–µ—Å—Å –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞:
   * 1. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
   * 2. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ (–ø—É–±–ª–∏—á–Ω—ã–π/–∑–∞—â–∏—â–µ–Ω–Ω—ã–π)
   * 3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
   * 4. –û—Ç–ø—Ä–∞–≤–∫–∞ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
   * 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –∏ –æ—à–∏–±–æ–∫
   * 
   * @param req - –ò—Å—Ö–æ–¥–Ω—ã–π HTTP –∑–∞–ø—Ä–æ—Å
   * @param next - –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
   * @returns Observable —Å —Å–æ–±—ã—Ç–∏—è–º–∏ HTTP –∑–∞–ø—Ä–æ—Å–∞
   */
  intercept(req: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {
    // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ª–æ–≥–æ–≤ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏
    console.group(`üîÑ INTERCEPTOR: ${req.method} ${req.url}`);
    
    /**
     * –°–ø–∏—Å–æ–∫ –ø—É–±–ª–∏—á–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï —Ç—Ä–µ–±—É—é—Ç JWT —Ç–æ–∫–µ–Ω–∞
     * –≠—Ç–∏ –º–∞—Ä—à—Ä—É—Ç—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ Authorization
     */
    const publicEndpoints = [
      '/api/auth/signin',  // –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
      '/api/auth/signup'   // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    ];

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å –ø—É–±–ª–∏—á–Ω—ã–º
    const isPublicEndpoint = publicEndpoints.some(endpoint => 
      req.url.includes(endpoint)
    );

    console.log('–ü—É–±–ª–∏—á–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç:', isPublicEndpoint);

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É–±–ª–∏—á–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
     * –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø—Ä–æ—Å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Ç–∞–∫ –∫–∞–∫ —Ç–æ–∫–µ–Ω –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
     */
    if (isPublicEndpoint) {
      console.log('‚úÖ –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –±–µ–∑ —Ç–æ–∫–µ–Ω–∞');
      console.groupEnd();
      return next.handle(req);
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
     * –î–ª—è —ç—Ç–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Ç—Ä–µ–±—É–µ—Ç—Å—è JWT —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
     */
    const token = this.authService.getToken();
    console.log('–¢–æ–∫–µ–Ω –∏–∑ AuthService:', token ? '–ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç' : '–û–¢–°–£–¢–°–¢–í–£–ï–¢');

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
     * –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –±–µ–∑ –Ω–µ–≥–æ (–≤–µ—Ä–Ω–µ—Ç—Å—è 401 –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞)
     */
    if (!token) {
      console.error('‚ùå –¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–ª—è –∑–∞—â–∏—â–µ–Ω–Ω–æ–≥–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞:', req.url);
      console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage:');
      console.log('   - auth-token:', localStorage.getItem('auth-token'));
      console.log('   - auth-user:', localStorage.getItem('auth-user'));
      console.groupEnd();
      return next.handle(req);
    }

    console.log('‚úÖ –¢–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∏');
    
    /**
     * –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∞ Authorization
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Bearer —Å—Ö–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
     */
    const cloned = req.clone({
      headers: req.headers.set('Authorization', `Bearer ${token}`)
    });

    // –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    console.log('üìã –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ—Å–ª–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:');
    cloned.headers.keys().forEach(key => {
      console.log(`   ${key}: ${cloned.headers.get(key)}`);
    });

    console.groupEnd();
    
    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ü–µ–ø–æ—á–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ —Å –ø–µ—Ä–µ—Ö–≤–∞—Ç–æ–º —Å–æ–±—ã—Ç–∏–π –∏ –æ—à–∏–±–æ–∫
     * –ò—Å–ø–æ–ª—å–∑—É–µ–º RxJS –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
     */
    return next.handle(cloned).pipe(
      /**
       * –û–ø–µ—Ä–∞—Ç–æ—Ä tap –¥–ª—è –ø–æ–±–æ—á–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
       * –õ–æ–≥–∏—Ä—É–µ—Ç —É—Å–ø–µ—à–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –∏ –æ—à–∏–±–∫–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞
       */
      tap(
        // –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
        event => console.log(`‚úÖ INTERCEPTOR: –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç ${req.url}`),
        // –û—à–∏–±–∫–∞ (—É—Å—Ç–∞—Ä–µ–≤—à–∏–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å, –æ–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è catchError)
        error => console.error(`‚ùå INTERCEPTOR: –û—à–∏–±–∫–∞ –æ—Ç ${req.url}:`, error)
      ),
      /**
       * –û–ø–µ—Ä–∞—Ç–æ—Ä catchError –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
       * –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –±–µ–∑ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –ø–æ—Ç–æ–∫–∞
       */
      catchError((error: HttpErrorResponse) => {
        console.error('üî¥ INTERCEPTOR: –ü–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–∞ –æ—à–∏–±–∫–∞:');
        console.error('   URL:', error.url);
        console.error('   Status:', error.status);
        console.error('   Status Text:', error.statusText);
        console.error('   Headers:', error.headers);
        console.error('   Error:', error.error);
        
        /**
         * –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ 401 Unauthorized
         * –≠—Ç–æ –º–æ–∂–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
         */
        if (error.status === 401) {
          console.error('üîê INTERCEPTOR: –û—à–∏–±–∫–∞ 401 - –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
          console.error('–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:');
          console.error('   1. –¢–æ–∫–µ–Ω –ø—Ä–æ—Å—Ä–æ—á–µ–Ω');
          console.error('   2. –¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω');
          console.error('   3. –ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π');
          console.error('   4. CORS –ø—Ä–æ–±–ª–µ–º—ã');
          
          // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
          const currentToken = this.authService.getToken();
          console.error('   –¢–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω –≤ –∏–Ω—Ç–µ—Ä—Ü–µ–ø—Ç–æ—Ä–µ:', currentToken ? '–ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç' : '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');
        }
        
        /**
         * –ü—Ä–æ–±—Ä–æ—Å –æ—à–∏–±–∫–∏ –¥–∞–ª—å—à–µ –ø–æ —Ü–µ–ø–æ—á–∫–µ
         * –ü–æ–¥–ø–∏—Å—á–∏–∫–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—É—á–∞—Ç —ç—Ç—É –æ—à–∏–±–∫—É
         */
        return throwError(error);
      })
    );
  }
}